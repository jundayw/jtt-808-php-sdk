<?php

namespace Jundayw\JTT808\MessageRequest;

class RTPRequest
{
    // public $codec = [
    //     1 => 'G.721',
    //     2 => 'G.722',
    //     3 => 'G.723',
    //     4 => 'G.728',
    //     5 => 'G.729',
    //     6 => 'G.711A',
    //     7 => 'G.711U',
    //     8 => 'G.726',
    //     9 => 'G.729A',
    //     10 => 'DVI4_3',
    //     11 => 'DVI4_4',
    //     12 => 'DVI4_8K',
    //     13 => 'DVI4_16K',
    //     14 => 'LPC',
    //     15 => 'S16BE_STEREO',
    //     16 => 'S16BE_MONO',
    //     17 => 'MPEGAUDIO',
    //     18 => 'LPCM',
    //     19 => 'AAC',
    //     20 => 'WMA9STD',
    //     21 => 'HEAAC',
    //     22 => 'PCM_VOICE',
    //     23 => 'PCM_AUDIO',
    //     24 => 'AACLC',
    //     25 => 'MP3',
    //     26 => 'ADPCMA',
    //     27 => 'MP4AUDIO',
    //     28 => 'AMR',
    //     98 => 'H.264',
    //     99 => 'H.265',
    //     100 => 'AVS',
    //     101 => 'SVAC',
    // ];

    public $frameFlag = '30316364';   // 帧头标识
    public $boundary = 0;             // 标志位，是否为完整数据边界
    public $payloadType;              // 负载类型
    public $sequence = 0;             // 包序号
    public $simNum;                   // SIM卡号
    public $channelId;                // 通道号
    public $type;                     // 数据类型
    public $package;                  // 分包标记
    public $timestamp;                // 时间戳
    public $lastIFrameTimestamp = 0;
    public $lastFrameTimestamp = 0;
    public $length = 0;           // 数据体长度
    public $body;                 // 数据体

    public $isVideo = false;             // 视频
    public $isAudio = false;             // 音频
    public $isTransmission = false;      // 透传

    public function decode($bytes = null)
    {
        // $bytes = hex2bin('303163648186000001827016705901300000018805601fa2014053505053535352525053535352525253535350505151505151565151575457575757545455d4d5d5d5d5d4d4d6d7d4d7d4d4d4d7d7d7d7d7d6d4d4d4d555555554545754555454d555d5d4d5d5d4d4d5d4d555d4d5d5d4d4d5d4d7d4d6d6d6d6d1d6d6d6d7d6d6d6d1d6d1d6d0d1d0d0d1d3d1d1d0d1d1d6d7d1d6d6d1d1d1d1d6d6d6d6d1d6d6d1d1d1d1d0d0d0d3d3d3d3d0d0d3d0d0d3d3d0d2d3d1d0d1d1d1d6d1d1d0d1d1d0d0d0d0d1d1d6d7d7d4d55555545454575757565757575757575657565151565656565656565156565651515656515150505053505153505051515156515051505352505350535253535253525d5d5d52525252525252535050515151515051515657515454565456565756575756575457575455575754575757565656515656515650515750565651545454555455555455545555555555');
        // $bytes = hex2bin('3031636481620004018270167059010100000188056020080000000003b6000000016764001facd2014016e8400000fa40001d53810000000168ea8f2c0000000165b8402fa43dc65b15653ee9ee42bf416f356411c235d061473ad1b59c17f4597348b6af621123c566b29e423bb297ede52db3bdd5383db26e647ab5e870fcbff958397adbb5fe175110ed2310e81196de29c8fc6aa91fb13545777a61c4dbc6b8221b4f9ec5aa7d3222601ff494de55cc64d249915b6420656116938bf911096757deb03462467afbe0c45a7f935ed9a875b69b770220a2ef921ff6a9fec8eedfc53bc51e52b7cc2a54dff0fdf7678e187b53da724e427358aae317eeec8b5fa09ccf267710ac13e9aa673cd8ffe97c0a7cb43857954e68daa5a27e4d91f4b80d99544bdb77fc9764241b92ce1112cbb932a307d8fdb9d593e18c93de421e9e76bd5319171e229d468afeb201bee49145d0a0a3b7e3d7afc0b5d737a56365f52c3dce2bb7529c6158f691bad698bb9465c69288f8a9e31b8225e99f645943697b44262f04db08c9f2e7a976597acbef65bb9d647d8f829f7cedd86c13f13b9447e6854ca67c4d279dc61310e0aab765b79d4f5ce4848fae4c6e6edae45c7005755e5d1ddcb1ab327fd6c7d0bf14307c180d961838d1fdc117e307bffbd33bdbf21c7a2d8acdc0edacd3660b86f2634d002f0bc7eb2cefea56cde4e53300ab2981d0b48aedd1e75931066b5ad8eae2ba004999515ac28e9bcbd4e79d86f5de0b7a4625e06653e67a7b6fcf72567bb8ac96e465c8eedabbf3c83034d4a93b418f04f3a6172a8fa45197f71262b8faefd2516316b5b5a88d32579111f78618eba271380cf35907419147bafa0672d121ea9a69a7009ced894dd911d2a35a556e931ef6d6b3da65bb0d4f04276e0024a3985beedc1c3e91df0923344fe76a5d2a9fab2b5ff8a50a2a5e6c43fd47483284d5641236580ab5dd0e6a105bce01249be0a3f1a89b3bd1e8221b36209e77a9632beeaab59f1ef6004de2124012ac49a946214f170508df892b1cf319de04f3a3f6111206ecd1bc65cff4c6aa6dd872dac453f34069bd8c06bb3e40b51921c1958a67e47c8f118912eb672d6811b147842424b8afde7dcfe7e87e0df0ca8eb5d779295f8a0171b80ae29e0e0402e778255b8cbf8581693eabf8113ed3228493665bb32dfc4edb6da8e031ef8c0ae8a10371101e2a04bcae4515fd8a3ab57ea4fc4294696bd7ff863c939ab0825969a58624df36caf2c4ba5a0282d3fe90243c6e900aa95db9f267fb42494c1f62b872170b1ae30906b7a7ba22a7c6495772d925097eb392e6d16e29b6464a3c3c8a934feb707bf3cb3d61676e0f98337d6b74faf2016999');
        // $bytes = hex2bin('3031636481e20004018270167059010100000188056020080000000003b6000000016764001facd2014016e8400000fa40001d53810000000168ea8f2c0000000165b8402fa43dc65b15653ee9ee42bf416f356411c235d061473ad1b59c17f4597348b6af621123c566b29e423bb297ede52db3bdd5383db26e647ab5e870fcbff958397adbb5fe175110ed2310e81196de29c8fc6aa91fb13545777a61c4dbc6b8221b4f9ec5aa7d3222601ff494de55cc64d249915b6420656116938bf911096757deb03462467afbe0c45a7f935ed9a875b69b770220a2ef921ff6a9fec8eedfc53bc51e52b7cc2a54dff0fdf7678e187b53da724e427358aae317eeec8b5fa09ccf267710ac13e9aa673cd8ffe97c0a7cb43857954e68daa5a27e4d91f4b80d99544bdb77fc9764241b92ce1112cbb932a307d8fdb9d593e18c93de421e9e76bd5319171e229d468afeb201bee49145d0a0a3b7e3d7afc0b5d737a56365f52c3dce2bb7529c6158f691bad698bb9465c69288f8a9e31b8225e99f645943697b44262f04db08c9f2e7a976597acbef65bb9d647d8f829f7cedd86c13f13b9447e6854ca67c4d279dc61310e0aab765b79d4f5ce4848fae4c6e6edae45c7005755e5d1ddcb1ab327fd6c7d0bf14307c180d961838d1fdc117e307bffbd33bdbf21c7a2d8acdc0edacd3660b86f2634d002f0bc7eb2cefea56cde4e53300ab2981d0b48aedd1e75931066b5ad8eae2ba004999515ac28e9bcbd4e79d86f5de0b7a4625e06653e67a7b6fcf72567bb8ac96e465c8eedabbf3c83034d4a93b418f04f3a6172a8fa45197f71262b8faefd2516316b5b5a88d32579111f78618eba271380cf35907419147bafa0672d121ea9a69a7009ced894dd911d2a35a556e931ef6d6b3da65bb0d4f04276e0024a3985beedc1c3e91df0923344fe76a5d2a9fab2b5ff8a50a2a5e6c43fd47483284d5641236580ab5dd0e6a105bce01249be0a3f1a89b3bd1e8221b36209e77a9632beeaab59f1ef6004de2124012ac49a946214f170508df892b1cf319de04f3a3f6111206ecd1bc65cff4c6aa6dd872dac453f34069bd8c06bb3e40b51921c1958a67e47c8f118912eb672d6811b147842424b8afde7dcfe7e87e0df0ca8eb5d779295f8a0171b80ae29e0e0402e778255b8cbf8581693eabf8113ed3228493665bb32dfc4edb6da8e031ef8c0ae8a10371101e2a04bcae4515fd8a3ab57ea4fc4294696bd7ff863c939ab0825969a58624df36caf2c4ba5a0282d3fe90243c6e900aa95db9f267fb42494c1f62b872170b1ae30906b7a7ba22a7c6495772d925097eb392e6d16e29b6464a3c3c8a934feb707bf3cb3d61676e0f98337d6b74faf2016999');
        // $bytes = hex2bin('303163648186000001827016705901300000018805601fa2014053505053535352525053535352525253535350505151505151565151575457575757545455d4d5d5d5d5d4d4d6d7d4d7d4d4d4d7d7d7d7d7d6d4d4d4d555555554545754555454d555d5d4d5d5d4d4d5d4d555d4d5d5d4d4d5d4d7d4d6d6d6d6d1d6d6d6d7d6d6d6d1d6d1d6d0d1d0d0d1d3d1d1d0d1d1d6d7d1d6d6d1d1d1d1d6d6d6d6d1d6d6d1d1d1d1d0d0d0d3d3d3d3d0d0d3d0d0d3d3d0d2d3d1d0d1d1d1d6d1d1d0d1d1d0d0d0d0d1d1d6d7d7d4d55555545454575757565757575757575657565151565656565656565156565651515656515150505053505153505051515156515051505352505350535253535253525d5d5d52525252525252535050515151515051515657515454565456565756575756575457575455575754575757565656515656515650515750565651545454555455555455545555555555');
        // $bytes = hex2bin('3031636481e2007c018270167059011300000188056020080000000002b1633f5c7f55bb276d639596e5e82f560b039a0ed2da2031a2175a15dd1b398254e1b9848ccf249dcba04a04db5aa952e481245bb1c7603da6ecfe7a50eb4e5eb70034629a236110860b1e45610b45cedd2ed46c7e3e5fffc0bf66bc4bfd353c97df542db675fad7c5daf1aa543332ee5802cd375844a4004a75a5ca2ac86c646a1f7acce46f08aea2ebec87daed7dc57badb9f87aaa8c8eade7ce2219b833b3961f8c9851edff38095982af8e7dbeeb16bbc955d1b3adf21774f3a51c0d518ad2d5817b40555ea1f696ed51950813b2a0cc5f867f5aab7f28367fcf3b5c4d6d8d750928629c82aecacfba9177fda2d30c2813f7429e4e13b96a3747411e828886af0da3f83e4e6e641a61fdfdea163d11dbe944a19ee98ffdcdbca2a25c474a1e038c8f91793d2d71c7e860c38cda62dde337d8d61389edf9777bfe77a145ec7b30a0c364403272b0755382e184c90d21d64b1412c53b268081c096e8916d1cbabbf3060ab49ce21824464ae360dfde965e9770d1749a6d877ea400898edbd6b4754725f8468d641731e5c32baebe7dab2ea38d998b25d75001ed4346fda30a539df5aa7f42299dd472d49540f51a1dcdf0721e06bbe9c036999a748c00553e5741190e4abca3575e7bc204b0567e5200cd34b704442dd65a1a408b1d8ff158aa8b493065b228728e9989ddb7957a429da55686e3ded098e71a7e359910fffe0a30be730bf9e4756c977b55039ed6189d443e30556fc5acb86fb61fd95dda1e2b9b3cf9d68118e58f163a53256654317aa4ab8196e5489f42fd5222ab349db7d982c659421f8ce64c613b69182f574b0f1c4953b5acd29df69cc1f4bbca0cf0260ecaa33c36a4e447538fa33e1088b839bfe55a6baa9228896f44214a6ed69231cbbd03e6faea8e590bf943c3005a960bf429cf8c01f85ccc280fb09ad8152eedc305c4992a51b532c2bb2c150aedd07d14');
        // $bytes = hex2bin('303163648186007d018270167059013000000188056020420140d7d7d6d6d1d6d6d1d6d6d7d6d6d4d6d4d4d7d4d7d4d6d1d7d1d3d0d6d0d3d0d1d0d3d2dcdcdddddcd2ddddd3d0d1d1d7d7d6d7d6d7d6d1d6d7d4d7d557555555555555545457565456515656505253505352525353505051515057515057565657555554d5d455555556565756535353505053505051515351505250535353505051505350535051505153505353505253505056565657545454545455d5d5d455d5d6d4d5d6d4d5d7d4d554545557545557d5d555d5555555545457d555575456565754555755555657575756565651565757545454d55555d4d4d5d6d6d7d7d6d1d7d6d7d6d6d7d7d5d4d4d7d4d5d6d6d6d7d7d6d7d6d7d4d4d7d7d4d4d7d7d7d4d7d6d6d4d6d6d6d4d4d7d7d6d6d1d0d0d0d0d0d3d3d3d2d3dddcdddcdfdfded9dfdfdfdcddddd3d0d3d3d2d2d2dcddddd2d3d2d3d0d6d7d7d4d7d7d7d6d6');
        // $bytes = hex2bin('303163648186007d018270167059013100000188056020420140d7d7d6d6d1d6d6d1d6d6d7d6d6d4d6d4d4d7d4d7d4d6d1d7d1d3d0d6d0d3d0d1d0d3d2dcdcdddddcd2ddddd3d0d1d1d7d7d6d7d6d7d6d1d6d7d4d7d557555555555555545457565456515656505253505352525353505051515057515057565657555554d5d455555556565756535353505053505051515351505250535353505051505350535051505153505353505253505056565657545454545455d5d5d455d5d6d4d5d6d4d5d7d4d554545557545557d5d555d5555555545457d555575456565754555755555657575756565651565757545454d55555d4d4d5d6d6d7d7d6d1d7d6d7d6d6d7d7d5d4d4d7d4d5d6d6d6d7d7d6d7d6d7d4d4d7d7d4d4d7d7d7d4d7d6d6d4d6d6d6d4d4d7d7d6d6d1d0d0d0d0d0d3d3d3d2d3dddcdddcdfdfded9dfdfdfdcddddd3d0d3d3d2d2d2dcddddd2d3d2d3d0d6d7d7d4d7d7d7d6d6');

        $type                 = substr($bytes, 15, 1);
        $type                 = ord($type) >> 4;
        $this->isVideo        = $type == 0b0000 || $type == 0b0001 || $type == 0b0010;
        $this->isAudio        = $type == 0b0011;
        $this->isTransmission = $type == 0b0100;

        if ($this->isVideo) {
            $data                      = unpack("Nframe_flag/Clabel/Cpayload/nsequence/H12sim_num/Cchannel_id/Ctype/H16timestamp/nlast_i_frame_timestamp/nlast_frame_timestamp/nlength", $bytes);
            $this->lastIFrameTimestamp = $data['last_i_frame_timestamp'];
            $this->lastFrameTimestamp  = $data['last_frame_timestamp'];
            $offset                    = 30;
        } else {
            $data   = unpack("Nframe_flag/Clabel/Cpayload/nsequence/H12sim_num/Cchannel_id/Ctype/H16timestamp/nlength", $bytes);
            $offset = 26;
        }

        $boundary          = $data['payload'] >> 7;
        $payloadType       = $data['payload'] & 0x7f;
        $type              = $data['type'] >> 4;
        $package           = $data['type'] & 0x0f;
        $data['timestamp'] = hexdec($data['timestamp']) / 1000;

        $this->frameFlag   = $data['frame_flag'];
        $this->boundary    = $boundary;
        $this->payloadType = $payloadType;
        $this->sequence    = $data['sequence'];
        $this->simNum      = $data['sim_num'];
        $this->channelId   = $data['channel_id'];
        $this->type        = $type;
        $this->package     = $package;
        $this->timestamp   = $data['timestamp'];
        $this->length      = $data['length'];
        $this->body        = substr($bytes, $offset, $this->length);

        return $this;
    }
}
